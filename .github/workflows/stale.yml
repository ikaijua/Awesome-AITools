name: Stale Issues and PRs

on:
  schedule:
    - cron: '0 0 * * *' # Runs daily at 00:00 UTC
  workflow_dispatch: # Allow manual trigger

permissions:
  issues: write
  pull-requests: write

jobs:
  stale:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Exempt specific issues and run stale action
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });

            // Issues to exempt from stale action
            const exemptIssueNumbers = [233, 232];

            // Get all non-exempt open issues
            const issuesToProcess = issues.filter(issue => !exemptIssueNumbers.includes(issue.number));

            console.log(`Found ${issues.length} open issues, ${exemptIssueNumbers.length} will be exempted, ${issuesToProcess.length} will be processed`);

            // For each issue to process, we'll check if it should be marked as stale
            // But instead of reinventing the wheel, we'll use the actions/stale action with a label filter

            // First, let's add a special label to exempt issues
            for (const issueNumber of exemptIssueNumbers) {
              try {
                // Check if issue has the exemption label
                const { data: issueLabels } = await github.rest.issues.listLabelsOnIssue({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber
                });

                const hasExemptionLabel = issueLabels.some(label => label.name === 'exempt-stale');

                if (!hasExemptionLabel) {
                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber,
                    labels: ['exempt-stale']
                  });
                  console.log(`Added exempt-stale label to issue ${issueNumber}`);
                } else {
                  console.log(`Issue ${issueNumber} already has exempt-stale label`);
                }
              } catch (error) {
                console.error(`Error handling issue ${issueNumber}:`, error);
              }
            }

            console.log('Exemption labels processed, now running stale action...');

      - name: Mark stale issues and PRs
        uses: actions/stale@v9
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

          # Issue configuration: Mark stale after 7 days, close after another 7 days (14 days total)
          stale-issue-message: 'This issue has been inactive for 7 days. It will be closed in 7 days if there is no activity.'
          close-issue-message: 'This issue has been closed due to inactivity for 14 days. Feel free to reopen if there are updates.'
          days-before-issue-stale: 7
          days-before-issue-close: 7

          # PR configuration: Mark stale after 7 days, close after another 7 days (14 days total)
          stale-pr-message: 'This PR has been inactive for 7 days. It will be closed in 7 days if there is no activity.'
          close-pr-message: 'This PR has been closed due to inactivity for 14 days. Feel free to reopen if there are updates.'
          days-before-pr-stale: 7
          days-before-pr-close: 7

          # Exempt issues with the 'exempt-stale' label
          exempt-issue-labels: 'exempt-stale'

          # Other configurations
          remove-stale-when-updated: true
          stale-issue-label: 'stale'
          stale-pr-label: 'stale'
